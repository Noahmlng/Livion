# 数据库架构文档 (Database Schema Documentation)

## 概述
本文档描述了项目的完整数据库架构，包含 8 个主要表格，用于管理用户数据、任务系统和积分系统。

**重要说明**: 原独立的 `goal` 表已被删除，现在使用 `user_goals` 表来管理目标。

---

## 表格结构

### 1. users (用户表)
存储用户的基本信息和设置。

```sql
create table public.users (
  user_id bigint generated by default as identity not null,
  password text not null,
  total_points real not null default 0,
  created_at timestamp with time zone not null default (now() AT TIME ZONE 'Asia/Taipei'::text),
  daily_pay real not null default 1000,
  user_goals jsonb null default '[]'::jsonb,
  user_competencies_to_develop jsonb null default '[]'::jsonb,
  points_settings jsonb null default '{}'::jsonb,
  constraint users_pkey primary key (user_id),
  constraint users_password_key unique (password),
  constraint users_daily_pay_positive check ((daily_pay > (0)::double precision))
) TABLESPACE pg_default;
```

### 2. behaviour (日常任务/行为模板)
存储可重复使用的日常任务模板。

```sql
create table public.behaviour (
  template_id bigint generated by default as identity not null,
  name text not null,
  description text null,
  reward_points real null default '0'::real,
  created_at timestamp with time zone not null default (now() AT TIME ZONE 'Asia/Taipei'::text),
  user_id bigint not null,
  constraint behaviour_pkey primary key (template_id),
  constraint behaviour_user_id_fkey foreign KEY (user_id) references users (user_id) on update CASCADE
) TABLESPACE pg_default;
```

### 3. challenge (支线任务) 
存储用户创建的挑战任务。

```sql
create table public.challenge (
  task_id bigint generated by default as identity not null,
  user_id bigint not null,
  name text not null,
  description text not null,
  created_at timestamp with time zone not null default (now() AT TIME ZONE 'Asia/Taipei'::text),
  priority integer not null default 0,
  status text not null default 'ongoing'::text,
  reward_points real not null default 0,
  image_path text null,
  constraint challenge_pkey primary key (task_id),
  constraint challenge_user_id_fkey foreign KEY (user_id) references users (user_id) on delete CASCADE
) TABLESPACE pg_default;

create index IF not exists idx_challenge_user_id on public.challenge using btree (user_id) TABLESPACE pg_default;

create index IF not exists idx_challenge_status on public.challenge using btree (status) TABLESPACE pg_default;
```

### 4. note (笔记表)
存储用户的笔记信息。

```sql
create table public.note (
  note_id bigint generated by default as identity not null,
  user_id bigint not null,
  content text not null,
  created_at timestamp with time zone not null default (now() AT TIME ZONE 'Asia/Taipei'::text),
  updated_at timestamp with time zone null default (now() AT TIME ZONE 'Asia/Taipei'::text),
  deleted_at timestamp with time zone null,
  pinned boolean not null default false,
  constraint note_pkey primary key (note_id),
  constraint note_user_id_fkey foreign KEY (user_id) references users (user_id) on delete CASCADE
) TABLESPACE pg_default;

create index IF not exists idx_note_pinned on public.note using btree (pinned) TABLESPACE pg_default;

create index IF not exists idx_note_pinned_updated_at on public.note using btree (pinned desc, updated_at desc) TABLESPACE pg_default;

create index IF not exists idx_note_user_id on public.note using btree (user_id) TABLESPACE pg_default;

create trigger update_note_updated_at BEFORE
update on note for EACH row
execute FUNCTION update_updated_at_column ();
```

### 5. points_history (积分历史)
记录用户的积分获取历史。

```sql
create table public.points_history (
  history_id bigint generated by default as identity not null,
  user_id bigint not null,
  task_id bigint null,
  schedule_entry_id bigint null,
  task_title text not null,
  task_record text null default ''::text,
  points_earned real not null,
  base_amount real not null,
  reward_amount real not null,
  reward_multiplier real not null,
  learning_reward real not null,
  estimated_time real not null,
  daily_pay real not null,
  reasoning text null default ''::text,
  provider text null default 'DeepSeek'::text,
  api_cost real null default 0,
  created_at timestamp with time zone not null default (now() AT TIME ZONE 'Asia/Taipei'::text),
  constraint points_history_pkey primary key (history_id),
  constraint points_history_challenge_id_fkey foreign KEY (task_id) references challenge (task_id) on delete set null,
  constraint points_history_user_id_fkey foreign KEY (user_id) references users (user_id) on delete CASCADE,
  constraint points_history_task_id_fkey foreign KEY (schedule_entry_id) references task (entry_id) on delete set null,
  constraint points_history_learning_reward_positive check ((learning_reward >= (0)::double precision)),
  constraint points_history_daily_pay_positive check ((daily_pay > (0)::double precision)),
  constraint points_history_points_earned_positive check ((points_earned >= (0)::double precision)),
  constraint points_history_reward_amount_positive check ((reward_amount >= (0)::double precision)),
  constraint points_history_reward_multiplier_positive check ((reward_multiplier >= (0)::double precision)),
  constraint points_history_base_amount_positive check ((base_amount >= (0)::double precision)),
  constraint points_history_estimated_time_positive check ((estimated_time >= (0)::double precision))
) TABLESPACE pg_default;

create index IF not exists idx_points_history_user_id on public.points_history using btree (user_id) TABLESPACE pg_default;

create index IF not exists idx_points_history_task_id on public.points_history using btree (task_id) TABLESPACE pg_default;

create index IF not exists idx_points_history_schedule_entry_id on public.points_history using btree (schedule_entry_id) TABLESPACE pg_default;

create index IF not exists idx_points_history_created_at on public.points_history using btree (created_at desc) TABLESPACE pg_default;

create index IF not exists idx_points_history_user_created_at on public.points_history using btree (user_id, created_at desc) TABLESPACE pg_default;
```

### 6. task (Slots中的任务列表)
存储用户时间段中的任务安排 (原 ScheduleEntry)。

```sql
create table public.task (
  entry_id bigint generated by default as identity not null,
  user_id bigint not null,
  date date not null,
  slot text not null,
  status text not null default 'ongoing'::text,
  task_type text not null,
  ref_task_id bigint null,
  ref_template_id bigint null,
  custom_name text null,
  description text null,
  reward_points real not null default 0,
  created_at timestamp with time zone not null default (now() AT TIME ZONE 'Asia/Taipei'::text),
  constraint task_pkey primary key (entry_id),
  constraint task_ref_behaviour_id_fkey foreign KEY (ref_template_id) references behaviour (template_id) on delete set null,
  constraint task_ref_challenge_id_fkey foreign KEY (ref_task_id) references challenge (task_id) on delete set null,
  constraint task_user_id_fkey foreign KEY (user_id) references users (user_id) on delete CASCADE
) TABLESPACE pg_default;

create index IF not exists idx_task_user_id on public.task using btree (user_id) TABLESPACE pg_default;

create index IF not exists idx_task_date on public.task using btree (date) TABLESPACE pg_default;

create index IF not exists idx_task_user_date on public.task using btree (user_id, date) TABLESPACE pg_default;

create index IF not exists idx_task_status on public.task using btree (status) TABLESPACE pg_default;
```

### 7. user_goals (用户目标表)
存储用户的目标信息。

```sql
create table public.user_goals (
  goal_id bigint generated by default as identity not null,
  user_id bigint not null,
  goal_text text not null,
  priority integer not null default 0,
  is_active boolean not null default true,
  created_at timestamp with time zone not null default (now() AT TIME ZONE 'Asia/Taipei'::text),
  updated_at timestamp with time zone not null default (now() AT TIME ZONE 'Asia/Taipei'::text),
  constraint user_goals_pkey primary key (goal_id),
  constraint user_goals_user_id_fkey foreign KEY (user_id) references users (user_id) on delete CASCADE
) TABLESPACE pg_default;

create index IF not exists idx_user_goals_user_id on public.user_goals using btree (user_id) TABLESPACE pg_default;
create index IF not exists idx_user_goals_priority on public.user_goals using btree (priority desc) TABLESPACE pg_default;

create trigger update_user_goals_updated_at BEFORE
update on user_goals for EACH row
execute FUNCTION update_updated_at_column ();
```

### 8. user_competencies_to_develop (用户希望培养的能力表)
存储用户希望发展的技能和能力。

```sql
create table public.user_competencies_to_develop (
  skill_id bigint generated by default as identity not null,
  user_id bigint not null,
  skill_text text not null,
  priority integer not null default 0,
  is_active boolean not null default true,
  created_at timestamp with time zone not null default (now() AT TIME ZONE 'Asia/Taipei'::text),
  updated_at timestamp with time zone not null default (now() AT TIME ZONE 'Asia/Taipei'::text),
  constraint user_competencies_to_develop_pkey primary key (skill_id),
  constraint user_competencies_to_develop_user_id_fkey foreign KEY (user_id) references users (user_id) on delete CASCADE
) TABLESPACE pg_default;

create index IF not exists idx_user_competencies_to_develop_user_id on public.user_competencies_to_develop using btree (user_id) TABLESPACE pg_default;
create index IF not exists idx_user_competencies_to_develop_priority on public.user_competencies_to_develop using btree (priority desc) TABLESPACE pg_default;

create trigger update_user_competencies_to_develop_updated_at BEFORE
update on user_competencies_to_develop for EACH row
execute FUNCTION update_updated_at_column ();
```

---

## 表关系说明

### 实体映射
- **Behaviour** (`behaviour` table) - 日常任务模板/行为模板
- **Challenge** (`challenge` table) - 支线任务/挑战
- **Task** (`task` table) - 时间段任务/日程任务 (原 ScheduleEntry)
- **Note** (`note` table) - 笔记
- **User** (`users` table) - 用户
- **UserGoal** (`user_goals` table) - 用户目标  
- **UserSkill** (`user_competencies_to_develop` table) - 用户技能
- **PointsHistory** (`points_history` table) - 积分历史

### 关键关系
1. `task.ref_task_id` → `challenge.task_id` (任务引用挑战)
2. `task.ref_template_id` → `behaviour.template_id` (任务引用行为模板)
3. `points_history.task_id` → `challenge.task_id` (积分历史关联挑战)
4. `points_history.schedule_entry_id` → `task.entry_id` (积分历史关联时间段任务)

---

## 更新说明

### 2024年最新更改

#### 重大架构简化 (最新更新)
- ✅ **完全移除目标关联**: `challenge` 表和 `note` 表中的 `goal_id` 字段已完全移除
- ✅ **简化任务系统**: 从 `challenge` 和 `task` 表中移除了 AI 评估相关的列：
  - `task_record` (任务记录)
  - `estimated_time` (预估时间)
  - `reward_multiplier` (奖励倍数)
  - `learning_reward` (学习奖励)
  - `points_calculated_at` (积分计算时间)
  - `ai_evaluation` (AI 评估结果)
- ✅ **优化索引结构**: 
  - 为 `note` 表添加了置顶功能相关索引 (`idx_note_pinned`, `idx_note_pinned_updated_at`)
  - 为 `points_history` 表添加了更多查询优化索引
  - 为 `challenge` 表添加了用户和状态索引
- ✅ **增强数据约束**: 
  - 为 `points_history` 表添加了多个正数检查约束，确保积分相关数值的有效性
  - 为 `users` 表添加了 `daily_pay` 正数约束
- ✅ **提升数据完整性**: 明确了多个列的可空性 (`null`/`not null`)

#### 历史更改
- ✅ **已解决**: 删除了独立的 `goal` 表
- ✅ **代码更新**: 所有相关的 Repository 和 Service 类已更新为使用 `user_goals` 表
- ✅ **类型系统**: TypeScript 类型定义已更新，编译无错误

### 代码架构更新
- `GoalRepository` → `UserGoalRepository`
- `GoalService` → `UserGoalService`
- `IGoalRepository` → `IUserGoalRepository`
- `IGoalService` → `IUserGoalService`
- `Goal` 类型 → `UserGoal` 类型

所有数据库连接现在使用正确的表名，应用程序可以正常运行。 